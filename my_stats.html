<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Stats | Kyosuke Shibuya</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], serif: ['"Noto Serif JP"', 'serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <header class="fixed top-0 w-full h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 z-40 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-xl text-gray-400 hover:text-gray-800 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="font-serif text-lg tracking-wider text-gray-800">My Stats</h1>
        </div>
        <div class="text-gray-400 text-sm"><i class="fa-solid fa-trophy"></i></div>
    </header>

    <main class="flex-grow pt-24 pb-20 px-4 max-w-4xl mx-auto w-full animate-fade-in">
        
        <div class="bg-gray-900 text-white rounded-lg p-6 shadow-lg mb-8 flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl transform translate-x-1/4 -translate-y-1/4">
                <i class="fa-solid fa-chart-pie"></i>
            </div>
            
            <div class="z-10 mb-6 md:mb-0">
                <div class="text-xs text-yellow-500 font-bold uppercase tracking-widest mb-1">Overall Progress</div>
                <h2 class="text-3xl font-serif font-bold mb-2">Total Achievement</h2>
                <p class="text-gray-400 text-sm">全カリキュラムの総合進捗率です。</p>
            </div>

            <div class="z-10 flex items-center gap-4">
                <div class="relative w-32 h-32">
                    <canvas id="totalChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col">
                        <span class="text-2xl font-bold font-mono text-white" id="total-percent">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mb-8">
            <h2 class="text-xl font-serif font-bold text-gray-800 mb-2">Subject Status</h2>
            <p class="text-xs text-gray-400 tracking-[0.2em]">科目別進捗状況</p>
        </div>

        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            </div>

        <div class="mt-12 border-t border-gray-200 pt-8">
            <h3 class="text-sm font-bold text-gray-500 tracking-widest mb-4 uppercase"><i class="fa-solid fa-file-csv mr-2"></i>Data Backup</h3>
            <div class="bg-white border border-gray-200 p-6 rounded-sm flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="text-xs text-gray-500">
                    <p class="mb-1 font-bold text-gray-700">学習データの保存</p>
                    <p>これまでに記録したすべての科目・すべてのログを、1つのExcelファイル（CSV）にまとめて出力します。</p>
                    <p class="mt-1">ポートフォリオの提出や、バックアップとして活用してください。</p>
                </div>
                <button onclick="downloadAllData()" class="bg-gray-800 text-white text-xs px-6 py-3 rounded hover:bg-gray-700 transition flex items-center gap-2 shadow-sm whitespace-nowrap">
                    <i class="fa-solid fa-download"></i> 全データをCSVで出力
                </button>
            </div>
        </div>

    </main>

    <script>
        // 設定データ（game.jsと同じ構造）
        const UNITS = {
            "math1_quadra": { total: 20, name: "数学I：二次関数", link: "math1_quadra.html" },
            "matha_prob": { total: 16, name: "数学A：場合の数と確率", link: "matha_prob.html" },
            "math2_equation_comp": { total: 12, name: "数学II：式と証明", link: "math2_equation_comp.html" },
            "math2_calculus": { total: 16, name: "数学II：微分積分", link: "math2_calculus.html" },
            "mathb_sequence": { total: 18, name: "数学B：数列", link: "mathb_sequence.html" },
            "mathc_vector": { total: 13, name: "数学C：平面ベクトル", link: "mathc_vector.html" },
            "mathc_vector3d": { total: 13, name: "数学C：空間ベクトル", link: "mathc_vector3d.html" }
        };

        // データ読み込み
        const rawData = localStorage.getItem('study_system_data');
        const data = rawData ? JSON.parse(rawData) : { completed: {} };
        const completed = data.completed || {};

        let totalItems = 0;
        let doneItems = 0;
        const grid = document.getElementById('stats-grid');

        // 各科目のカード生成
        for (const [key, config] of Object.entries(UNITS)) {
            const unitDone = Object.keys(completed).filter(k => k.startsWith(key)).length;
            const percent = Math.floor((unitDone / config.total) * 100);
            
            totalItems += config.total;
            doneItems += unitDone;

            const isComplete = percent === 100;

            const html = `
                <div class="bg-white p-5 rounded border ${isComplete ? 'border-yellow-400 bg-yellow-50' : 'border-gray-200'} shadow-sm hover:shadow-md transition group relative overflow-hidden">
                    ${isComplete ? '<div class="absolute top-0 right-0 bg-yellow-400 text-white text-[10px] font-bold px-2 py-1 rounded-bl shadow-sm"><i class="fa-solid fa-crown"></i> COMPLETE</div>' : ''}
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="font-bold text-gray-700 text-sm mb-1">${config.name}</h3>
                            <div class="text-xs text-gray-400 font-mono">Progress: ${unitDone} / ${config.total}</div>
                        </div>
                        <div class="text-xl font-serif font-bold ${isComplete ? 'text-yellow-600' : 'text-gray-300'}">
                            ${percent}<span class="text-xs">%</span>
                        </div>
                    </div>

                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mb-4">
                        <div class="h-full ${isComplete ? 'bg-yellow-500' : 'bg-gray-800'} transition-all duration-1000" style="width: ${percent}%"></div>
                    </div>

                    <div class="flex justify-end gap-2">
                        ${isComplete ? `
                            <button onclick="alert('修了証は各科目ページの100%達成時に表示されます。科目のページへ移動してください。')" class="text-[10px] bg-yellow-100 text-yellow-700 px-3 py-1.5 rounded hover:bg-yellow-200 transition">
                                <i class="fa-solid fa-medal"></i> Certificate
                            </button>
                        ` : ''}
                        <a href="${config.link}" class="text-[10px] bg-gray-800 text-white px-3 py-1.5 rounded hover:bg-gray-700 transition flex items-center gap-1">
                            Go to Study <i class="fa-solid fa-arrow-right"></i>
                        </a>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', html);
        }

        // 総合チャート描画
        const totalPercent = totalItems === 0 ? 0 : Math.floor((doneItems / totalItems) * 100);
        document.getElementById('total-percent').innerText = `${totalPercent}%`;

        const ctx = document.getElementById('totalChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Done', 'Remaining'],
                datasets: [{
                    data: [totalPercent, 100 - totalPercent],
                    backgroundColor: ['#eab308', '#374151'], 
                    borderWidth: 0,
                    cutout: '80%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } }
            }
        });

        // 全データをCSV出力する関数
        function downloadAllData() {
            if(doneItems === 0) {
                alert("まだ学習ログがありません。まずは学習を進めましょう！");
                return;
            }

            // CSVヘッダー
            let csvContent = "\uFEFF科目名,回数,学習ログ(内容)\n";

            // 全データを走査
            for (const [unitKey, config] of Object.entries(UNITS)) {
                // その単元のデータを抽出
                const unitLogs = [];
                for (let i = 1; i <= config.total; i++) {
                    const itemId = `${unitKey}_item_${i}`;
                    if (completed[itemId]) {
                        unitLogs.push({ num: i, text: completed[itemId] });
                    }
                }

                // 番号順にソートしてCSVに追加
                unitLogs.sort((a, b) => a.num - b.num).forEach(log => {
                    // カンマや改行をエスケープ
                    const safeText = `"${log.text.replace(/"/g, '""')}"`;
                    csvContent += `${config.name},第${log.num}回,${safeText}\n`;
                });
            }

            // ダウンロード処理
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            // ファイル名に日付を入れる
            const date = new Date();
            const dateStr = date.toISOString().slice(0,10).replace(/-/g, ""); // YYYYMMDD
            
            link.setAttribute("href", url);
            link.setAttribute("download", `Learning_Portfolio_All_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>