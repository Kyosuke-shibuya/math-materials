<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Stats | Kyosuke Shibuya</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], serif: ['"Noto Serif JP"', 'serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <header class="fixed top-0 w-full h-16 bg-gray-900 text-white flex items-center justify-between px-6 z-40 shadow-md">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-xl focus:outline-none hover:text-gray-300 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="font-serif text-lg tracking-wider">My Stats</h1>
        </div>
        <div class="text-gray-500 text-sm"><i class="fa-solid fa-chart-pie"></i></div>
    </header>

    <main class="flex-grow pt-24 pb-20 px-4 max-w-4xl mx-auto w-full animate-fade-in">
        
        <div class="text-center mb-10">
            <h2 class="text-2xl font-serif font-bold text-gray-800 mb-2">Learning Progress</h2>
            <p class="text-xs text-gray-400 tracking-[0.3em] uppercase">学習データの可視化とバックアップ</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col items-center justify-center">
                <h3 class="text-sm font-bold text-gray-500 tracking-widest mb-4">TOTAL PROGRESS</h3>
                <div class="w-48 h-48 relative">
                    <canvas id="totalChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                        <span id="total-percent" class="text-3xl font-bold text-gray-800">0%</span>
                        <span class="text-[10px] text-gray-400">COMPLETED</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col justify-center items-center text-center h-full">
                    <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-3">
                        <i class="fa-solid fa-file-csv text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-800 mb-2">Data Backup</h3>
                    <p class="text-xs text-gray-500 mb-4">
                        学習ログをCSVファイルとして出力します。<br>
                        ポートフォリオとしての提出に最適です。
                    </p>
                    <button onclick="downloadCSV()" class="bg-gray-800 hover:bg-gray-700 text-white text-xs font-bold py-2 px-6 rounded transition flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> CSV DOWNLOAD
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <h3 class="bg-gray-50 text-xs font-bold text-gray-500 tracking-widest p-4 border-b border-gray-200 flex justify-between items-center">
                <span>SUBJECT BREAKDOWN</span>
                <span class="text-[10px] text-red-500"><i class="fa-solid fa-lock mr-1"></i>Protected Access</span>
            </h3>
            <div id="unit-list" class="divide-y divide-gray-100">
                </div>
        </div>

    </main>

    <footer class="bg-gray-900 text-gray-400 py-8 px-6 text-center text-xs mt-auto">
        <p class="font-serif tracking-wider">&copy; 2025 Kyosuke Shibuya Mathematics.</p>
    </footer>

    <div id="password-modal" class="fixed inset-0 bg-gray-900/95 flex items-center justify-center z-[100] opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-lg p-8 max-w-sm w-full shadow-2xl transform scale-95 transition-transform duration-300" id="modal-content">
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-600">
                    <i class="fa-solid fa-lock text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">Protected Content</h3>
                <p class="text-xs text-gray-500 mt-2">このページにアクセスするにはパスワードが必要です。</p>
            </div>
            
            <div class="space-y-4">
                <input type="password" id="password-input" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded focus:outline-none focus:border-yellow-500 focus:ring-1 focus:ring-yellow-500 transition font-mono text-center tracking-widest">
                <div id="error-msg" class="text-red-500 text-xs text-center hidden">パスワードが間違っています</div>
                
                <button onclick="checkPassword()" class="w-full bg-gray-900 text-white py-3 rounded font-bold hover:bg-gray-700 transition">
                    ENTER
                </button>
                <button onclick="closeModal()" class="w-full text-xs text-gray-400 hover:text-gray-600 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        const UNITS = {
            "math1_numb": { total: 22, name: "数学I：数と式・集合と論証", link: "math1_numb.html" },
            "math1_quadra": { total: 20, name: "数学I：二次関数", link: "math1_quadra.html" },
            "matha_prob": { total: 16, name: "数学A：場合の数と確率", link: "matha_prob.html" },
            "math2_equation_comp": { total: 12, name: "数学II：式と証明・複素数", link: "math2_equation_comp.html" },
            "math2_calculus": { total: 16, name: "数学II：微分積分", link: "math2_calculus.html" },
            "mathb_sequence": { total: 18, name: "数学B：数列", link: "mathb_sequence.html" },
            "mathc_vector": { total: 13, name: "数学C：平面ベクトル", link: "mathc_vector.html" },
            "mathc_vector3d": { total: 13, name: "数学C：空間ベクトル", link: "mathc_vector3d.html" }
        };

        // ▼▼▼ 修正箇所：game.jsと同じ形式でデータを読み込む ▼▼▼
        function getCompletedData() {
            const saved = localStorage.getItem('study_system_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // game.jsは { completed: {...}, driveUrl: ... } の形式で保存している
                    return data.completed || {};
                } catch (e) {
                    console.error("Data parse error", e);
                    return {};
                }
            }
            return {};
        }

        // 描画処理
        window.addEventListener('DOMContentLoaded', () => {
            const completed = getCompletedData();
            const listContainer = document.getElementById('unit-list');
            
            let totalItems = 0;
            let totalCompleted = 0;

            Object.keys(UNITS).forEach(key => {
                const config = UNITS[key];
                let unitCompleted = 0;

                for (let i = 1; i <= config.total; i++) {
                    const itemId = `${key}_item_${i}`;
                    if (completed[itemId]) {
                        unitCompleted++;
                    }
                }

                totalItems += config.total;
                totalCompleted += unitCompleted;
                
                const percentage = Math.round((unitCompleted / config.total) * 100);
                
                let barColor = "bg-gray-200";
                if (percentage === 100) barColor = "bg-yellow-500";
                else if (percentage > 0) barColor = "bg-blue-500";

                // クリックでconfirmAccessを呼ぶように設定
                const html = `
                    <div onclick="confirmAccess('${config.link}')" class="p-4 flex items-center justify-between hover:bg-gray-50 transition cursor-pointer group">
                        <div class="flex-1">
                            <div class="flex justify-between mb-1">
                                <span class="font-bold text-sm text-gray-700 group-hover:text-yellow-600 transition">${config.name}</span>
                                <span class="text-xs font-mono text-gray-500">${unitCompleted} / ${config.total}</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                <div class="${barColor} h-1.5 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                        <div class="ml-4 w-12 text-right flex flex-col items-end gap-1">
                            <span class="text-xs font-bold ${percentage === 100 ? 'text-yellow-600' : 'text-gray-400'}">${percentage}%</span>
                            <i class="fa-solid fa-lock text-[10px] text-gray-200 group-hover:text-yellow-500 transition"></i>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });

            // 円グラフ
            const totalPercentage = totalItems > 0 ? Math.round((totalCompleted / totalItems) * 100) : 0;
            document.getElementById('total-percent').textContent = `${totalPercentage}%`;

            const ctx = document.getElementById('totalChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Remaining'],
                    datasets: [{
                        data: [totalCompleted, totalItems - totalCompleted],
                        backgroundColor: ['#EAB308', '#F3F4F6'],
                        borderWidth: 0,
                        cutout: '80%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        });

        // CSVダウンロード
        function downloadCSV() {
            const completed = getCompletedData();
            let csvContent = "\uFEFFSubject,Lesson,Log\n";

            for (const [unitKey, config] of Object.entries(UNITS)) {
                const unitLogs = [];
                for (let i = 1; i <= config.total; i++) {
                    const itemId = `${unitKey}_item_${i}`;
                    if (completed[itemId]) {
                        unitLogs.push({ num: i, text: completed[itemId] });
                    }
                }
                unitLogs.sort((a, b) => a.num - b.num).forEach(log => {
                    const safeText = `"${log.text.replace(/"/g, '""')}"`;
                    csvContent += `${config.name},第${log.num}回,${safeText}\n`;
                });
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const date = new Date();
            const dateStr = date.toISOString().slice(0,10).replace(/-/g, "");
            link.setAttribute("href", url);
            link.setAttribute("download", `Learning_Portfolio_All_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ▼▼ パスワード関連ロジック ▼▼
        const CORRECT_PASSWORD = "2025";
        const modal = document.getElementById('password-modal');
        const modalContent = document.getElementById('modal-content');
        const input = document.getElementById('password-input');
        const errorMsg = document.getElementById('error-msg');
        let targetUrl = "";

        function confirmAccess(url) {
            targetUrl = url;
            modal.classList.remove('pointer-events-none', 'opacity-0');
            modalContent.classList.remove('scale-95');
            modalContent.classList.add('scale-100');
            input.value = "";
            errorMsg.classList.add('hidden');
            setTimeout(() => input.focus(), 100);
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-95');
        }

        function checkPassword() {
            if (input.value === CORRECT_PASSWORD) {
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fa-solid fa-check-circle text-5xl text-green-500 mb-4 animate-bounce"></i>
                        <h3 class="text-xl font-bold text-gray-800">Access Granted</h3>
                    </div>
                `;
                setTimeout(() => {
                    window.location.href = targetUrl;
                }, 800);
            } else {
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500', 'bg-red-50');
                modalContent.classList.add('animate-pulse');
                setTimeout(() => {
                    input.classList.remove('border-red-500', 'bg-red-50');
                    modalContent.classList.remove('animate-pulse');
                }, 500);
            }
        }

        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });
    </script>
    <script>
    // PWAとして起動している場合、リンクをブラウザではなくアプリ内で開く処理
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        document.addEventListener('click', function(e) {
            // クリックされた要素がリンク(aタグ)かどうか判定
            const anchor = e.target.closest('a');
            
            // リンクでない、または外部サイトへのリンク等の場合は何もしない
            if (!anchor || !anchor.getAttribute('href')) return;
            const href = anchor.getAttribute('href');
            
            // 以下は除外（通常通りブラウザや別タブで開く）
            // 1. target="_blank" が指定されている (PDFなど)
            // 2. 外部サイト (httpから始まる)
            // 3. ページ内リンク (#から始まる)
            if (anchor.getAttribute('target') === '_blank' || 
                href.startsWith('http') || 
                href.startsWith('#')) {
                return;
            }

            // それ以外（内部ページへの移動）なら、ブラウザ起動をキャンセルしてアプリ内で移動
            e.preventDefault();
            window.location.href = href;
        });
    }
</script>
</body>
</html>