<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Log History | Kyosuke Shibuya</title>
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500&family=Noto+Serif+JP:wght@400;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'], serif: ['"Noto Serif JP"', 'serif'] },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-in-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <header class="fixed top-0 w-full h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 z-40 shadow-sm">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-xl text-gray-400 hover:text-gray-800 transition">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <h1 class="font-serif text-lg tracking-wider text-gray-800">My Portfolio</h1>
        </div>
        <div class="text-gray-400 text-sm"><i class="fa-solid fa-pen-nib"></i></div>
    </header>

    <main class="flex-grow pt-24 pb-20 px-4 max-w-4xl mx-auto w-full animate-fade-in">
        
        <div class="grid grid-cols-2 gap-4 mb-10">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 text-center">
                <div class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-1">Total Logs</div>
                <div class="text-3xl font-serif text-gray-800" id="total-count">0</div>
                <div class="text-[10px] text-gray-400 mt-1">posts</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100 text-center">
                <div class="text-xs text-gray-400 font-bold uppercase tracking-widest mb-1">Total Words</div>
                <div class="text-3xl font-serif text-yellow-600" id="total-chars">0</div>
                <div class="text-[10px] text-gray-400 mt-1">characters</div>
            </div>
        </div>

        <div class="text-center mb-10">
            <h2 class="text-xl font-serif font-bold text-gray-800 mb-2">Learning History</h2>
            <p class="text-xs text-gray-400 tracking-[0.2em]">学びの軌跡</p>
        </div>

        <div id="logs-container" class="space-y-8">
            </div>

        <div id="no-data-msg" class="hidden text-center py-20 text-gray-400 italic">
            まだ学習ログがありません。<br>各単元のページで学びを記録しましょう。
        </div>

    </main>

    <script>
        // 科目名のマッピング定義
        const unitMap = {
            "math1_quadra": "数学 I：二次関数",
            "matha_prob": "数学 A：場合の数と確率",
            "math2_equation_comp": "数学 II：式と証明・複素数",
            "math2_calculus": "数学 II：微分積分",
            "mathb_sequence": "数学 B：数列",
            "mathc_vector": "数学 C：平面ベクトル",
            "mathc_vector3d": "数学 C：空間ベクトル"
        };

        // データ読み込み
        const rawData = localStorage.getItem('study_system_data');
        const data = rawData ? JSON.parse(rawData) : { completed: {} };
        const logs = data.completed || {};

        const container = document.getElementById('logs-container');
        const totalCountElem = document.getElementById('total-count');
        const totalCharsElem = document.getElementById('total-chars');

        let totalLogs = 0;
        let totalChars = 0;
        
        // データを科目ごとにグループ化
        const groupedLogs = {};
        
        Object.keys(logs).forEach(key => {
            // key形式: unitId_item_number (例: math1_quadra_item_1)
            const parts = key.split('_item_');
            if(parts.length < 2) return;
            
            const unitId = parts[0];
            const itemNum = parts[1];
            const content = logs[key];

            if (!groupedLogs[unitId]) groupedLogs[unitId] = [];
            groupedLogs[unitId].push({ num: parseInt(itemNum), content: content });
            
            totalLogs++;
            totalChars += content.length;
        });

        // 統計反映
        totalCountElem.innerText = totalLogs;
        totalCharsElem.innerText = totalChars.toLocaleString();

        if (totalLogs === 0) {
            document.getElementById('no-data-msg').classList.remove('hidden');
        } else {
            // グループごとにHTML生成
            for (const [unitId, items] of Object.entries(groupedLogs)) {
                // 番号順にソート
                items.sort((a, b) => a.num - b.num);

                const unitName = unitMap[unitId] || unitId;
                
                let itemsHTML = items.map(item => `
                    <div class="bg-white p-5 rounded border-l-4 border-yellow-400 shadow-sm hover:shadow-md transition">
                        <div class="flex justify-between items-baseline mb-3">
                            <span class="font-serif text-lg font-bold text-gray-800">No.${item.num}</span>
                            <span class="text-[10px] font-mono text-gray-400">${item.content.length}文字</span>
                        </div>
                        <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">${item.content}</p>
                    </div>
                `).join('');

                const sectionHTML = `
                    <section class="animate-fade-in">
                        <div class="flex items-center gap-3 mb-4 border-b border-gray-200 pb-2">
                            <i class="fa-solid fa-book-bookmark text-gray-400"></i>
                            <h3 class="text-md font-bold text-gray-700">${unitName}</h3>
                        </div>
                        <div class="grid gap-4">
                            ${itemsHTML}
                        </div>
                    </section>
                `;
                container.insertAdjacentHTML('beforeend', sectionHTML);
            }
        }
    </script>

    <script>
    // PWAとして起動している場合、リンクをブラウザではなくアプリ内で開く処理
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
        document.addEventListener('click', function(e) {
            // クリックされた要素がリンク(aタグ)かどうか判定
            const anchor = e.target.closest('a');
            
            // リンクでない、または外部サイトへのリンク等の場合は何もしない
            if (!anchor || !anchor.getAttribute('href')) return;
            const href = anchor.getAttribute('href');
            
            // 以下は除外（通常通りブラウザや別タブで開く）
            // 1. target="_blank" が指定されている (PDFなど)
            // 2. 外部サイト (httpから始まる)
            // 3. ページ内リンク (#から始まる)
            if (anchor.getAttribute('target') === '_blank' || 
                href.startsWith('http') || 
                href.startsWith('#')) {
                return;
            }

            // それ以外（内部ページへの移動）なら、ブラウザ起動をキャンセルしてアプリ内で移動
            e.preventDefault();
            window.location.href = href;
        });
    }
</script>
</body>
</html>